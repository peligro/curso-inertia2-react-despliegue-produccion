name: Laravel CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_KEY: ${{ secrets.APP_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_DATABASE: ${{ secrets.DB_DATABASE }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      AWS_USE_PATH_STYLE_ENDPOINT: ${{ secrets.AWS_USE_PATH_STYLE_ENDPOINT }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GEMINI_BASE_URL: ${{ secrets.GEMINI_BASE_URL }}
      VITE_APP_URL: ${{ secrets.VITE_APP_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'âœ… SSH connection successful!'"

      - name: Despliegue en EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e  # Exit on error
            cd /home/ubuntu/proyecto
             
            echo "ğŸ”„ Pulling latest code from main branch..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ğŸ“ Creating .env file from .env.example..."
            # Copiar .env.example como base
            cp .env.example .env
            
            # FunciÃ³n para actualizar o agregar variables
            update_env_var() {
              local key="$1"
              local value="$2"
              
              if grep -q "^$key=" .env; then
                # Reemplazar variable existente
                sed -i "s|^$key=.*|$key=$value|" .env
              else
                # Agregar variable nueva al final
                echo "$key=$value" >> .env
              fi
            }
            
            # Actualizar variables especÃ­ficas
            update_env_var "APP_KEY" "${{ secrets.APP_KEY }}"
            update_env_var "APP_DEBUG" "false"
            update_env_var "APP_ENV" "production"
            update_env_var "APP_URL" "http://${{ secrets.EC2_HOST }}"
            
            update_env_var "DB_CONNECTION" "pgsql"
            update_env_var "DB_HOST" "${{ secrets.DB_HOST }}"
            update_env_var "DB_PORT" "${{ secrets.DB_PORT }}"
            update_env_var "DB_DATABASE" "${{ secrets.DB_DATABASE }}"
            update_env_var "DB_USERNAME" "${{ secrets.DB_USERNAME }}"
            update_env_var "DB_PASSWORD" "${{ secrets.DB_PASSWORD }}"
            
            update_env_var "AWS_USE_PATH_STYLE_ENDPOINT" "${{ secrets.AWS_USE_PATH_STYLE_ENDPOINT }}"
            
            update_env_var "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}"
            update_env_var "DEEPSEEK_API_KEY" "${{ secrets.DEEPSEEK_API_KEY }}"
            update_env_var "DEEPSEEK_API_URL" "${{ secrets.DEEPSEEK_API_URL }}"
            update_env_var "GEMINI_API_KEY" "${{ secrets.GEMINI_API_KEY }}"
            update_env_var "GEMINI_BASE_URL" "${{ secrets.GEMINI_BASE_URL }}"
            
            update_env_var "VITE_APP_URL" "${{ secrets.VITE_APP_URL }}"
            
            echo "ğŸ” Setting file permissions..."
            chmod -R 755 storage bootstrap/cache
            chmod 644 .env
            
            echo "ğŸ³ Stopping and cleaning Docker containers..."
            docker compose down --remove-orphans || true
            docker system prune -a -f || true
            docker volume prune -f || true
            
            echo "ğŸ—ï¸ Building and starting containers..."
            docker compose up --build -d
            
            echo "â³ Waiting for containers to be ready..."
            sleep 30
            
            echo "ğŸ“¦ Running migrations..."
            docker exec peligro-laravel-app php artisan migrate --force
            
            echo "âš¡ Optimizing application..."
            docker exec peligro-laravel-app php artisan optimize
            
            echo "âœ… Verifying deployment..."
            # Verificar que vendor existe
            docker exec peligro-laravel-app ls -la vendor/ > /dev/null && echo "âœ… Vendor directory exists"
            # Verificar que assets compilados existen
            docker exec peligro-laravel-app ls -la public/build/ > /dev/null && echo "âœ… Build assets exist"
            
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"